# Auto Deploy 项目需求规格说明书

**版本**: 1.0  
**日期**: 2025-11-20  
**项目**: Auto Deploy - 自动化部署工具

---

## 1. 项目概述

### 1.1 项目背景
Auto Deploy 是一个基于 Ansible 的自动化部署工具,旨在简化多节点软件安装和配置流程。通过配置文件驱动、多线程并发执行和现代化 TUI 界面,提供高效、可靠、易用的部署体验。

### 1.2 项目目标
- 支持多节点并发部署,提高部署效率
- 提供直观的图形化界面,实时展示部署进度和日志
- 支持多种软件的自动化安装和配置
- 提供完善的错误处理和回滚机制
- 易于扩展,支持新软件的快速集成

### 1.3 目标用户
- 运维工程师:批量部署和管理服务器
- 开发人员:快速搭建开发/测试环境
- 系统管理员:标准化软件安装流程

---

## 2. 功能需求

### 2.1 配置文件管理

#### FR-1.1 配置文件格式
- **描述**: 使用 YAML 格式定义部署配置
- **优先级**: P0（必须）
- **详细说明**:
  - 支持全局配置（日志、数据目录等）
  - 支持多节点配置
  - 支持每个节点的软件安装列表

#### FR-1.2 节点配置
- **描述**: 支持完整的节点连接配置
- **优先级**: P0（必须）
- **配置项**:
  - `host`: 主机地址（IP 或域名）
  - `port`: SSH 端口（默认 22）
  - `owner_user`: 普通用户名
  - `owner_pass`: 普通用户密码（可选,与密钥认证二选一）
  - `owner_key`: 普通用户 SSH 私钥路径（可选）
  - `super_user`: 管理员用户名
  - `super_pass`: 管理员密码（可选）
  - `super_key`: 管理员 SSH 私钥路径（可选）

#### FR-1.3 软件安装配置
- **描述**: 支持详细的软件安装参数
- **优先级**: P0（必须）
- **配置项**:
  - `name`: 软件名称（如 java, python, zookeeper）
  - `version`: 软件版本（如 11, 3.9.0, 3.7.1）
  - `install_path`: 安装路径
  - `source`: 软件包来源（可选:local/url/repository）
  - `source_path`: 软件包路径或 URL（可选）
  - `config`: 安装后配置参数（可选,字典类型）

**配置示例**:
```yaml
nodes:
  - node_01:
      host: '192.168.1.1'
      port: 22
      owner_user: 'sivan'
      owner_key: '~/.ssh/id_rsa'
      super_user: 'root'
      super_pass: 'linux123!@#'
      install:
        - java:
            version: '11'
            install_path: '/usr/local/java'
            source: 'url'
            source_path: 'https://example.com/jdk-11.tar.gz'
            config:
              set_java_home: true
              add_to_path: true
```

#### FR-1.4 配置验证
- **描述**: 加载配置文件时进行完整性和合法性验证
- **优先级**: P0（必须）
- **验证项**:
  - 必填字段检查
  - 数据类型检查
  - 路径合法性检查
  - 端口范围检查（1-65535）
  - SSH 密钥文件存在性检查

---

### 2.2 安装前检查（Pre-installation Checks）

#### FR-2.1 连通性检查
- **描述**: 验证目标节点的网络连通性和 SSH 可访问性
- **优先级**: P0（必须）
- **检查项**:
  - 主机可达性（ping）
  - SSH 端口连通性
  - SSH 认证成功（密码或密钥）
  - sudo/root 权限验证

#### FR-2.2 软件安装状态检查
- **描述**: 检查目标软件是否已安装
- **优先级**: P0（必须）
- **行为**:
  - 已安装且版本匹配:跳过安装
  - 已安装但版本不匹配:提示用户选择（覆盖/跳过/取消）
  - 未安装:继续安装流程

#### FR-2.3 系统兼容性检查
- **描述**: 验证目标系统是否支持待安装软件
- **优先级**: P1（重要）
- **检查项**:
  - 操作系统类型（CentOS/Ubuntu/Debian/RedHat）
  - 操作系统版本
  - 系统架构（x86_64/ARM）

#### FR-2.4 资源检查
- **描述**: 验证系统资源是否满足安装要求
- **优先级**: P1（重要）
- **检查项**:
  - 磁盘空间（安装路径和 /tmp）
  - 可用内存
  - 安装路径写权限

#### FR-2.5 依赖检查
- **描述**: 检查软件依赖是否满足
- **优先级**: P1（重要）
- **检查项**:
  - 前置软件依赖（如 Tomcat 依赖 Java）
  - 系统库依赖（如 glibc 版本）
  - 端口占用检查（软件所需端口是否可用）

#### FR-2.6 检查结果处理
- **描述**: 根据检查结果决定后续操作
- **优先级**: P0（必须）
- **行为**:
  - 所有检查通过:继续安装
  - 存在警告:显示警告信息,用户确认后继续
  - 存在错误:停止该节点的安装流程,不影响其他节点

---

### 2.3 多线程并发执行

#### FR-3.1 并发控制
- **描述**: 支持多节点并发部署,提高效率
- **优先级**: P0（必须）
- **参数**:
  - `max_concurrent_nodes`: 最大并发节点数（默认 10）
  - 可在配置文件中自定义

#### FR-3.2 线程池管理
- **描述**: 使用线程池管理并发任务
- **优先级**: P0（必须）
- **实现**:
  - 使用 `concurrent.futures.ThreadPoolExecutor`
  - 动态调整线程池大小（不超过节点总数和最大并发数）

#### FR-3.3 任务调度
- **描述**: 智能调度部署任务
- **优先级**: P1（重要）
- **策略**:
  - 按节点并行执行
  - 单节点内的软件按顺序安装（保证依赖关系）
  - 支持任务优先级（未来扩展）

---

### 2.4 Ansible 集成

#### FR-4.1 Ansible Runner 封装
- **描述**: 封装 `ansible_runner` 库,提供统一接口
- **优先级**: P0（必须）
- **功能**:
  - 执行 Ansible Playbook
  - 实时捕获执行输出
  - 返回执行结果（成功/失败/状态码）

#### FR-4.2 软件安装器抽象
- **描述**: 定义软件安装器基类,支持扩展
- **优先级**: P0（必须）
- **设计**:
  - 抽象基类 `BaseInstaller`
  - 每种软件实现子类（`JavaInstaller`, `PythonInstaller` 等）
  - 子类实现方法:
    - `pre_check()`: 安装前检查
    - `install()`: 执行安装
    - `post_config()`: 安装后配置
    - `verify()`: 安装验证

#### FR-4.3 内置 Playbook
- **描述**: 提供常用软件的 Ansible Playbook
- **优先级**: P0（必须）
- **支持软件**:
  - Java (JDK 8/11/17)
  - Python (2.7/3.x)
  - Zookeeper
  - 未来扩展:MySQL, Redis, Nginx, Tomcat 等

#### FR-4.4 自定义 Playbook 支持
- **描述**: 允许用户提供自定义 Playbook
- **优先级**: P2（可选）
- **实现**:
  - 配置文件中指定 `custom_playbook` 路径
  - 系统优先使用自定义 Playbook

---

### 2.5 错误处理

#### FR-5.1 节点级错误隔离
- **描述**: 单个节点失败不影响其他节点
- **优先级**: P0（必须）
- **行为**:
  - 节点失败后,停止该节点的后续任务
  - 其他节点继续执行
  - 记录失败原因和详细日志

#### FR-5.2 软件级错误处理
- **描述**: 单个软件安装失败的处理策略
- **优先级**: P0（必须）
- **行为**:
  - 安装失败后,停止该节点的后续软件安装
  - 标记该软件为失败状态
  - 可选:尝试回滚（删除部分安装的文件）

#### FR-5.3 错误日志记录
- **描述**: 详细记录所有错误信息
- **优先级**: P0（必须）
- **内容**:
  - 错误时间
  - 节点信息
  - 软件名称和版本
  - 错误类型和堆栈跟踪
  - Ansible 执行日志

#### FR-5.4 失败重试机制
- **描述**: 支持失败任务的自动重试
- **优先级**: P2（可选）
- **参数**:
  - `max_retries`: 最大重试次数（默认 0,不重试）
  - `retry_delay`: 重试间隔（秒）

---

### 2.6 命令行界面（CLI）

#### FR-6.1 基础命令
- **描述**: 提供完整的 CLI 命令
- **优先级**: P0（必须）
- **命令列表**:
  ```bash
  auto-deploy --help                    # 显示帮助
  auto-deploy version                   # 显示版本
  auto-deploy generate-config           # 生成配置模板
  auto-deploy -c config.yml             # CLI 模式执行部署
  auto-deploy -c config.yml --tui       # TUI 模式执行部署
  auto-deploy -c config.yml --dry-run   # 仅执行检查,不实际安装
  ```

#### FR-6.2 CLI 输出
- **描述**: CLI 模式下的输出格式
- **优先级**: P0（必须）
- **内容**:
  - 部署进度（百分比）
  - 当前执行的节点和任务
  - 成功/失败统计
  - 彩色输出（使用 `rich` 库）

#### FR-6.3 Dry-run 模式
- **描述**: 仅执行检查,不实际安装
- **优先级**: P1（重要）
- **行为**:
  - 执行所有安装前检查
  - 显示将要执行的操作
  - 不执行实际的 Ansible Playbook

---

### 2.7 图形化界面（TUI）

#### FR-7.1 主界面布局
- **描述**: 使用 Textual 框架构建现代化 TUI
- **优先级**: P0（必须）
- **布局**:
  - 顶部:标题栏（版本、配置文件名）
  - 左侧:节点状态列表（树形结构）
  - 右上:总体进度条和统计信息
  - 右下:实时日志滚动窗口
  - 底部:快捷键提示

#### FR-7.2 节点状态显示
- **描述**: 实时显示每个节点的部署状态
- **优先级**: P0（必须）
- **状态图标**:
  - ⏸ Pending（待执行）
  - ⏳ Running（执行中）
  - ✓ Completed（已完成）
  - ✗ Failed（失败）
  - ⚠ Warning（警告）

#### FR-7.3 进度条
- **描述**: 显示整体和单节点的部署进度
- **优先级**: P0（必须）
- **内容**:
  - 总体进度百分比
  - 已完成/总节点数
  - 已完成/总任务数
  - 已用时间和预计剩余时间

#### FR-7.4 实时日志
- **描述**: 滚动显示部署日志
- **优先级**: P0（必须）
- **功能**:
  - 自动滚动到最新日志
  - 日志级别颜色区分（INFO/WARNING/ERROR）
  - 支持暂停滚动（查看历史日志）
  - 支持日志过滤（按节点、级别）

#### FR-7.5 交互操作
- **描述**: 支持键盘交互
- **优先级**: P1（重要）
- **快捷键**:
  - `S`: 开始部署
  - `P`: 暂停部署
  - `R`: 恢复部署
  - `Q`: 退出（需确认）
  - `F`: 切换日志过滤
  - `↑/↓`: 滚动日志
  - `Tab`: 切换焦点区域

#### FR-7.6 主题支持
- **描述**: 支持颜色主题切换
- **优先级**: P2（可选）
- **主题**:
  - 暗色主题（默认）
  - 亮色主题

---

### 2.8 日志和报告

#### FR-8.1 日志记录
- **描述**: 完整记录部署过程
- **优先级**: P0（必须）
- **日志级别**:
  - DEBUG: 调试信息
  - INFO: 一般信息
  - WARNING: 警告信息
  - ERROR: 错误信息

#### FR-8.2 日志文件
- **描述**: 将日志保存到文件
- **优先级**: P0（必须）
- **文件**:
  - 主日志:`deploy_data/log/deploy.log`
  - 按节点分离:`deploy_data/log/node_01.log`
  - 日志轮转（按大小或时间）

#### FR-8.3 部署报告
- **描述**: 生成部署总结报告
- **优先级**: P1（重要）
- **格式**:
  - JSON 格式（机器可读）
  - Markdown 格式（人类可读）
- **内容**:
  - 部署时间
  - 节点列表和状态
  - 成功/失败统计
  - 错误详情
  - 性能指标（总耗时、平均耗时）

---

## 3. 非功能需求

### 3.1 性能需求

#### NFR-1.1 并发性能
- 支持至少 50 个节点的并发部署
- 单节点部署延迟 < 5 秒（不含软件下载时间）

#### NFR-1.2 响应性能
- TUI 界面刷新率 ≥ 10 FPS
- 日志更新延迟 < 500ms

### 3.2 可靠性需求

#### NFR-2.1 错误恢复
- 网络中断后自动重连（可配置）
- 进程崩溃后可从断点恢复（未来扩展）

#### NFR-2.2 数据完整性
- 配置文件损坏时提供明确错误提示
- 日志文件写入失败不影响部署流程

### 3.3 可用性需求

#### NFR-3.1 易用性
- 配置文件语法简单,提供详细注释
- 错误提示清晰,包含解决建议
- 提供完整的用户文档

#### NFR-3.2 兼容性
- 支持 Python 3.8+
- 支持主流 Linux 发行版（CentOS 7+, Ubuntu 18.04+, Debian 10+）
- 支持 macOS（仅作为控制端）

### 3.4 可维护性需求

#### NFR-4.1 代码质量
- 代码覆盖率 ≥ 80%
- 遵循 PEP 8 代码规范
- 使用类型注解（Type Hints）

#### NFR-4.2 可扩展性
- 新增软件支持只需实现子类,无需修改核心代码
- 支持插件机制（未来扩展）

### 3.5 安全需求

#### NFR-5.1 凭证安全
- 配置文件中的密码支持加密存储（未来扩展）
- SSH 私钥文件权限检查（必须 600）
- 不在日志中记录明文密码

#### NFR-5.2 权限控制
- 最小权限原则:优先使用普通用户,仅必要时使用 sudo
- 安装路径权限检查

---

## 4. 约束条件

### 4.1 技术约束
- 必须使用 Python 3.8+
- 必须使用 Ansible 作为底层执行引擎
- TUI 必须使用 Textual 框架
- CLI 输出必须使用 Rich 库

### 4.2 环境约束
- 控制端需要安装 Ansible 和 Python 依赖
- 目标节点需要支持 SSH 连接
- 目标节点需要安装 Python（Ansible 要求）

### 4.3 时间约束
- 第一版本开发周期:2-3 周
- 核心功能优先,可选功能后续迭代

---

## 5. 验收标准

### 5.1 功能验收
- [ ] 成功部署至少 3 种软件（Java, Python, Zookeeper）
- [ ] 支持至少 10 个节点的并发部署
- [ ] TUI 界面正常显示,实时更新状态
- [ ] CLI 模式正常工作,输出清晰
- [ ] 安装前检查正常工作,能识别已安装软件
- [ ] 单节点失败不影响其他节点

### 5.2 性能验收
- [ ] 10 个节点并发部署,总耗时 < 单节点串行的 30%
- [ ] TUI 界面流畅,无明显卡顿

### 5.3 质量验收
- [ ] 单元测试覆盖率 ≥ 80%
- [ ] 所有代码通过 Pylint 检查（评分 ≥ 8.0）
- [ ] 提供完整的 README 和使用文档

---

## 6. 术语表

| 术语 | 定义 |
|------|------|
| TUI | Text-based User Interface,基于文本的用户界面 |
| Ansible | 开源的自动化运维工具 |
| Playbook | Ansible 的配置文件,定义自动化任务 |
| Ansible Runner | Ansible 的 Python 封装库 |
| Dry-run | 模拟执行,不实际修改系统 |
| 节点 | 需要部署软件的目标主机 |
| 安装器 | 负责特定软件安装的类 |

---

## 7. 附录

### 7.1 配置文件完整示例

```yaml
# 全局配置
general:
  data_dir: './deploy_data'
  max_concurrent_nodes: 10

# 日志配置
log:
  level: 'INFO'
  dir: './deploy_data/log'

# 节点配置
nodes:
  - node_01:
      host: '192.168.1.1'
      port: 22
      owner_user: 'sivan'
      owner_key: '~/.ssh/id_rsa'
      super_user: 'root'
      super_pass: 'linux123!@#'
      install:
        - java:
            version: '11'
            install_path: '/usr/local/java'
            source: 'url'
            source_path: 'https://cdn.example.com/jdk-11.0.12_linux-x64_bin.tar.gz'
            config:
              set_java_home: true
              add_to_path: true
        - python:
            version: '3.9.7'
            install_path: '/usr/local/python'
            source: 'url'
            source_path: 'https://www.python.org/ftp/python/3.9.7/Python-3.9.7.tgz'
        - zookeeper:
            version: '3.7.1'
            install_path: '/usr/local/zookeeper'
            config:
              data_dir: '/data/zookeeper'
              client_port: 2181

  - node_02:
      host: '192.168.1.2'
      port: 22
      owner_user: 'peter'
      owner_pass: 'linux123!@#'
      super_user: 'root'
      super_key: '~/.ssh/root_id_rsa'
      install:
        - java:
            version: '11'
            install_path: '/usr/local/java'
```

### 7.2 参考资料
- [Ansible Documentation](https://docs.ansible.com/)
- [Ansible Runner Documentation](https://ansible-runner.readthedocs.io/)
- [Textual Documentation](https://textual.textualize.io/)
- [Rich Documentation](https://rich.readthedocs.io/)

---

**文档结束**
